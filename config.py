"""
Конфигурационный файл для телеграм-бота новостей.
Здесь хранятся все основные настройки бота и источники новостей.
"""

import os
from pathlib import Path

from dotenv import load_dotenv

# Загружаем переменные окружения из .env файла
_BASE_DIR = Path(__file__).resolve().parent
# Загружаем только реальные файлы окружения, а не шаблоны с примерами
_ENV_FILENAMES = (".env",)
_ENV_DIRS = (_BASE_DIR, _BASE_DIR.parent, Path.cwd())
for env_dir in _ENV_DIRS:
    for env_name in _ENV_FILENAMES:
        load_dotenv(env_dir / env_name)



def _env_bool(name: str, default: bool) -> bool:
    value = os.getenv(name)
    if value is None:
        return default
    return value.strip().lower() in {'1', 'true', 'yes', 'on'}


def _env_int(name: str, default: int) -> int:
    value = os.getenv(name)
    if value is None:
        return default
    try:
        return int(value)
    except ValueError:
        return default


def _env_float(name: str, default: float) -> float:
    value = os.getenv(name)
    if value is None:
        return default
    try:
        return float(value)
    except ValueError:
        return default

# Токен бота, полученный от @BotFather в Telegram
BOT_TOKEN = os.getenv('BOT_TOKEN', '')

# ID канала, куда будут публиковаться новости
# Формат: @channel_username или -1001234567890 (числовой ID)
CHANNEL_ID = os.getenv('CHANNEL_ID', '-1003531603514')

# Максимальная длина поста в символах
MAX_POST_LENGTH = 4500

# Минимальная задержка перед публикацией новости, чтобы сгруппировать похожие темы
PUBLISH_DELAY_MINUTES = _env_int('PUBLISH_DELAY_MINUTES', 30)

# Интервал проверки источников (в секундах)
CHECK_INTERVAL_SECONDS = _env_int('CHECK_INTERVAL_SECONDS', 300)

# Публиковать ли срочные новости вне ежедневной сводки
ENABLE_BREAKING_NEWS = _env_bool('ENABLE_BREAKING_NEWS', True)

# Порог приоритета для срочной публикации
BREAKING_NEWS_MIN_PRIORITY = _env_float('BREAKING_NEWS_MIN_PRIORITY', 7.5)

# Максимум срочных публикаций в час (излишки уйдут в мини-сводку)
BREAKING_MAX_PER_HOUR = _env_int('BREAKING_MAX_PER_HOUR', 3)

# Максимум пунктов в мини-сводке по срочным новостям
BREAKING_MINI_DIGEST_MAX_ITEMS = _env_int('BREAKING_MINI_DIGEST_MAX_ITEMS', 8)

# Вести подробный лог разложения score по компонентам
DEBUG_PRIORITY_LOGGING = _env_bool('DEBUG_PRIORITY_LOGGING', False)

# Максимальная динамическая поправка порога срочности при высоком/низком потоке
BREAKING_DYNAMIC_THRESHOLD_DELTA = _env_float('BREAKING_DYNAMIC_THRESHOLD_DELTA', 1.0)

# Настройки повторов запросов к RSS
RSS_FETCH_RETRY_ATTEMPTS = _env_int('RSS_FETCH_RETRY_ATTEMPTS', 3)
RSS_FETCH_RETRY_BACKOFF_SECONDS = _env_float('RSS_FETCH_RETRY_BACKOFF_SECONDS', 1.5)

# Куда отправлять ежедневный служебный отчёт (опционально)
# Формат: @username или chat_id. Пусто — отчёты отключены.
ADMIN_CHAT_ID = os.getenv('ADMIN_CHAT_ID', '5322247321')

# Расписание структурированных дайджестов (МСК)
MIDDAY_DIGEST_HOUR_MSK = _env_int('MIDDAY_DIGEST_HOUR_MSK', 12)
MIDDAY_DIGEST_MINUTE_MSK = _env_int('MIDDAY_DIGEST_MINUTE_MSK', 0)

SUPPLEMENT_DIGEST_HOUR_MSK = _env_int('SUPPLEMENT_DIGEST_HOUR_MSK', 12)
SUPPLEMENT_DIGEST_MINUTE_MSK = _env_int('SUPPLEMENT_DIGEST_MINUTE_MSK', 20)

EVENING_DIGEST_HOUR_MSK = _env_int('EVENING_DIGEST_HOUR_MSK', 19)
EVENING_DIGEST_MINUTE_MSK = _env_int('EVENING_DIGEST_MINUTE_MSK', 0)

# Сколько часов назад брать новости для полного дневного отчёта
DIGEST_LOOKBACK_HOURS = _env_int('DIGEST_LOOKBACK_HOURS', 24)

# Количество новостей для проверки за один раз
NEWS_CHECK_BATCH = 20


# Сколько приоритетных постов публиковать за один цикл
MAX_POSTS_PER_PUBLISH_CYCLE = 3

# Период полураспада новизны (в часах) для скоринга важности
PRIORITY_RECENCY_HALF_LIFE_HOURS = 12

# Вес надежности источников (чем выше, тем выше приоритет)
SOURCE_RELIABILITY_WEIGHTS = {
    'ТАСС Мир': 1.4,
    'ТАСС Россия': 1.4,
    'ТАСС Экономика': 1.3,
    'РБК Россия': 1.25,
    'РБК Экономика': 1.25,
    'Коммерсант Политика': 1.2,
    'Независимая газета': 1.1,
    'BBC Russian': 1.2,
    'Российская Газета Мир': 1.1,
}

# Маркеры высокой важности
HIGH_IMPORTANCE_KEYWORDS = [
    'экстр', 'срочно', 'санкц', 'закон принят', 'подписал закон', 'указ',
    'чрезвычайное положение', 'эвакуац', 'мобилизац', 'перемир', 'ceasefire',
    'взят в плен', 'наступлен', 'обстрел', 'ракетн удар', 'теракт'
]

# Маркеры средней важности
MEDIUM_IMPORTANCE_KEYWORDS = [
    'переговор', 'саммит', 'встреч', 'заявил', 'сообщил', 'договор',
    'инфляц', 'ставк', 'рынок', 'бюджет', 'прогноз', 'реформ', 'голосован',
    'выбор', 'декрет', 'резолюц'
]

# Базовый приоритет по теме
TOPIC_BASE_PRIORITY = {
    'конфликт': 3.0,
    'политика': 2.2,
    'экономика': 2.0,
    'общество': 1.5,
}

# База данных для хранения опубликованных новостей
DATABASE_PATH = 'news_bot.db'

# Дней хранения истории опубликованных новостей в базе
# После этого срока старые записи автоматически удаляются (экономия места)
DAYS_TO_KEEP_HISTORY = 30

# Список источников новостей (RSS фиды)
# Оставляем только новости по миру, России и экономике
NEWS_SOURCES = [
    {'name': 'Коммерсант Политика', 'url': 'https://www.kommersant.ru/RSS/section-politics.xml', 'category': 'мир'},
    {'name': 'Независимая газета', 'url': 'https://www.ng.ru/rss/', 'category': 'россия'},
    {'name': 'ТАСС Мир', 'url': 'https://tass.ru/rss/v2.xml', 'category': 'мир'},
    {'name': 'ТАСС Россия', 'url': 'https://tass.ru/rss/v2.xml?sections=Russia', 'category': 'россия'},
    {'name': 'ТАСС Экономика', 'url': 'https://tass.ru/rss/v2.xml?sections=Economy', 'category': 'экономика'},
    {'name': 'РБК Россия', 'url': 'https://rssexport.rbc.ru/rbcnews/news/30/full.rss', 'category': 'россия'},
    {'name': 'РБК Экономика', 'url': 'https://rssexport.rbc.ru/rbcnews/news/20/full.rss', 'category': 'экономика'},
    {'name': 'BBC Russian', 'url': 'https://www.bbc.com/russian/index.xml', 'category': 'мир'},
    {'name': 'Российская Газета Мир', 'url': 'https://rg.ru/xml/index.xml', 'category': 'мир'},
]

# Целевые рубрики дневного отчёта
CATEGORIES = [
    'россия: политика',
    'россия: экономика',
    'россия: безопасность',
    'мир: геополитика',
    'мир: экономика',
    'мир: жизнь за рубежом'
]

# Ключевые слова, указывающие на новости о вооружённых конфликтах
ARMED_CONFLICT_KEYWORDS = [
    'войн', 'боев', 'боестолкнов', 'боевые действия', 'фронт', 'линия фронта',
    'обстрел', 'ракетн', 'бпла', 'дрон', 'удар', 'контрнаступ', 'наступлен',
    'артиллери', 'авиаудар', 'всу', 'вс рф', 'минобороны', 'генштаб',
    'вооружен', 'вооружён', 'армия', 'бригада', 'батальон', 'мобилизац',
    'военн', 'конфликт', 'ceasefire', 'frontline', 'shelling', 'missile',
    'drone strike', 'military operation', 'armed clash', 'idf', 'hamas',
    'хусит', 'йемен', 'газ', 'сектор газа', 'сирия'
]

# Ключевые слова для определения региона
WORLD_KEYWORDS = [
    'мир', 'международн', 'оон', 'нато', 'евросоюз', 'ес', 'g7', 'g20',
    'foreign', 'international', 'diplomat', 'summit', 'united nations',
    'сша', 'украин', 'китай', 'герман', 'франц', 'британи', 'япони', 'польша',
    'израил', 'иран', 'турци', 'ближн', 'африк', 'латиноамерик', 'европ',
    'макрон', 'мерц', 'трамп', 'байден'
]

RUSSIA_KEYWORDS = [
    'росси', 'рф', 'москва', 'московск', 'кремл', 'правительств', 'госдума',
    'совфед', 'реги', 'област', 'край', 'республик', 'губернатор', 'президент',
    'премьер', 'кабинет', 'нацпроект', 'федеральн', 'минфин', 'минэконом',
    'минздрав', 'минобр', 'минтранс'
]

# Экономические маркеры (строгая рубрика «Экономическая ситуация • РФ»)
ECONOMY_KEYWORDS = [
    'эконом', 'инфляц', 'валют', 'рубл', 'курс', 'бюджет', 'финанс', 'рынок',
    'акци', 'бирж', 'инвест', 'бан', 'кредит', 'ставк', 'налог', 'ввп', 'рост',
    'промышлен', 'экспорт', 'импорт', 'энергет', 'нефт', 'газ', 'тариф',
    'субсид', 'санкц', 'производ', 'логист', 'зарплат', 'потребител',
    'рознич', 'спрос', 'доход', 'реальн доход', 'безработиц'
]

# Явно неэкономические социальные темы, которые нельзя относить к экономике
NON_ECONOMIC_SOCIAL_KEYWORDS = [
    'учител', 'педагог', 'школ', 'образован', 'студент', 'вуз', 'больниц',
    'поликлиник', 'медицин', 'социальн', 'льгот', 'пенсионер', 'демограф',
    'культур', 'театр', 'музы', 'кино', 'выставк'
]

# Политические маркеры
POLITICS_KEYWORDS = [
    'президент', 'премьер', 'правительств', 'госдум', 'совфед', 'закон',
    'парламент', 'выбор', 'дипломат', 'санкц', 'переговор', 'саммит',
    'мид', 'кремл', 'ес', 'нато', 'оон', 'макрон', 'трамп', 'байден'
]

# Общественные (неэкономические) маркеры
SOCIETY_KEYWORDS = [
    'учител', 'педагог', 'школ', 'образован', 'студент', 'вуз', 'социальн',
    'здравоохран', 'медици', 'семья', 'дет', 'волонтер', 'пособи', 'пенси',
    'экологи', 'культур', 'обществен'
]


# Ключевые слова, которые дают «ложный конфликтный шум»
NON_CONFLICT_NOISE_KEYWORDS = [
    'спорт', 'культур', 'шоу', 'кино', 'музы', 'погода', 'лайфхак', 'гороскоп',
    'автомобил', 'смартфон', 'блогер', 'шоу-бизнес', 'сериал', 'туризм'
]

# Топики, которые нужно исключить для источников РФ (спорт, культура, наука, происшествия)
EXCLUDED_RUSSIAN_TOPICS_KEYWORDS = [
    'спорт', 'футбол', 'хокке', 'матч', 'лига', 'кубок', 'чемпион',
    'культур', 'театр', 'музы', 'кино', 'фильм', 'выставк', 'литератур',
    'наук', 'учен', 'исследован', 'лаборатор', 'космос',
    'происшеств', 'чп', 'дтп', 'пожар', 'авари', 'катастроф', 'взрыв'
]

EXCLUDED_RUSSIAN_SOURCES = {
    'ТАСС Россия',
    'ТАСС Экономика',
    'РБК Россия',
    'РБК Экономика'
}

# Ключевые слова для отсева локальной криминальной хроники
LOCAL_NOISE_CRIME_KEYWORDS = [
    'пья', 'пьян', 'алкогол', 'дебош', 'мелк', 'карманн', 'краж', 'вор', 'граб',
    'хулиган', 'свалил', 'угнал велосипед', 'украл велосипед'
]

# Маркеры локальных новостей уровня района/города
LOCAL_NEWS_MARKERS = [
    'в районе', 'на улице', 'местный житель', 'житель ', 'в городе', 'в посёлке', 'в поселке',
    'по области', 'районный', 'городской суд', 'в администрации города'
]

# Признаки «новостей-затычек» (малополезные/пустые материалы)
LOW_VALUE_NEWS_PATTERNS = [
    'без подробностей',
    'детали уточняются',
    'следите за обновлениями',
    'подробности позже',
    'стало известно',
    'шок',
    'срочно',
    'видео',
    'фото'
]

# Минимальная длина осмысленного описания новости
MIN_DESCRIPTION_LENGTH = 80

# Общие криминальные маркеры (фильтруем по умолчанию)
CRIME_CONTENT_KEYWORDS = [
    'убил', 'убий', 'зарезал', 'расстрел', 'стрельб', 'нападен', 'ограб', 'граб', 'краж',
    'вор', 'изнасил', 'мошенн', 'преступ', 'задержан', 'арестован', 'суд приговорил',
    'полиция', 'прокуратур', 'свoдка', 'поножовщина', 'драка', 'разбой', 'хулиган'
]

# Исключения: криминальные события глобального масштаба/террор, которые публикуем
ALLOWED_GLOBAL_CRIME_KEYWORDS = [
    'теракт', 'террорист', 'terror', 'isis', 'игил', 'аль-каида',
    'массовая стрельба', 'вооруженное нападение', 'чрезвычайное положение',
    'санкции', 'международн', 'оон', 'евросоюз', 'нато', 'глобальн',
    'энергетическ', 'кибератак', 'инфраструктур', 'авиасообщени', 'границ'
]
